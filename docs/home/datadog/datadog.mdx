# DataDog Integrations

<font color="grey" size="5" >Guide to implement Datadog in Outshifter's platforms</font>

## AWS ACS

For integrate Datadog in the cluster is necessary add a new container using the image "**datadog/agent:latest**" and configure it with the corrects variables, volumes and mount points.

**Variables**:
- DD_API_KEY
- DD_ENV
- DD_SERVICE
- DD_SITE

In the cluster:

![enviroments-variables](/static/home/enviroments-variables.png)

**Volumes**:

- Name: docker_sock 
- Volume type: Bind Mount 
- Source path: /var/run/docker.sock
--------------------------------------------
- Name: proc 
- Volume type: Bind Mount 
- Source: path /proc/
--------------------------------------------
- Name: cgroup 
- Volume type: Bind Mount 
- Source: path /sys/fs/cgroup/

In the cluster:

![volumes](/static/home/volumes.png)

**Mount Points**

| Container Path       | Source Volume |
| -------------------- | ------------- |
| /host/sys/fs/cgroup  | cgroup        |
| /var/run/docker.sock | docker_sock   |
| /host/proc           | proc          |

In the cluster:

![mount-points](/static/home/mount-points.png)

With this configuration now we can monitor the cluster and its containers in the Datadog Portal.

![infraestructure1](/static/home/infraestructure1.png)

![infraestructure2](/static/home/infraestructure2.png)

## Gitlab Pipelines

For add a Pipeline integration we need configure the repository in Gitlab, in the menu bar click settings -> integrations and search Datadog and then click it.

â€‹
![addintegration](/static/home/addintegration.png)

Inside of the settings we need to modified the Datadog site to "datadoghq.eu", the API Key and add a tag if is necessary.

![activeintegrations](/static/home/activeintegrations.png)

If is the configuration it's ok, the Datatog's portal show the pipelines when they are triggered.

![activeintegrations2](/static/home/activeintegrations2.png)

## Tests

### Setup DataDog Portal

To implement the Tests in Datadog we need to go to the portal and do click in the menu bar section CI -> Settings and then Test Service Setup.

![testingvisibility](/static/home/testingvisibility.png)

Now in the portal, we're going to configure the Test, first step is select the language, in this case Javascript with the Framework Jest.

![testenviroment](/static/home/testenviroment.png)

Then we choose the provider, for us is Cloud, the variables that the portal says that we need to add, we will configure in Gitlab after to setup all up on this page.

![ci](/static/home/ci.png)

After the provider we need to install a package in our project with the command:

```
npm install --save-dev dd-trace
```
```
yarn add dd-trace --dev
```

Finally we need to set the field DD_SERVICE with the name of the app, this point is very important, because Datadog is listening the app with the same name.

![runtest](/static/home/runtest.png)

we need to leave that tab listening in the browser until it finds the Pipeline running with the test, don't close it.

### Setup Variables in Gitlab

Now is time to setup our variables in the Gitlab portal, search your repository and go to menu bar setting -> CI/CD ,  the variables were mentioned in the previous step, they are:

- DD_CIVISIBILITY_AGENTLESS_ENABLED = true

- DD_API_KEY = { my api key }

- DD_SITE = datadoghq.eu

- DD_APM_ENABLED = true

![generalpipelines](/static/home/generalpipelines.png)

### Setup file .gitlab-ci.yml

We need setup your file that use to execute the pipeline in Gitlab, in the stage of tests we need to use the image from Datadog "datadog/agent:latest".

Example: In the next case, in the block of scripts, we create a file to can use our packages and install all the dependencies and in the last line we use the command that Datadog give us, look that the DD_SERVICE needs be the same that you seted in the Datadog portal.

![packagejson](/static/home/packagejson.png)

Finally done all these, we can run the Pipeline in Gitlab and then the Datadog portal find our test and add it to the dashboard and review the details.

![testservice](/static/home/testservice.png)